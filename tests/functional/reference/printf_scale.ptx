.version 7.0
.target sm_80
.address_size 64

// Square kernel with device printf (spec ยง5.3 registration-path test).
// For each thread: prints "idx=%u\n" and writes output[i] = input[i] * input[i].
// The runtime auto-injects the printf ring-buffer arguments (spec ยง6.5 step 10).
.visible .entry printf_scale(
    .param .u64 param_input,
    .param .u64 param_output
)
{
    .reg .u64  %rd<6>;
    .reg .f32  %f<2>;
    .reg .u32  %r<5>;

    ld.param.u64 %rd0, [param_input];
    ld.param.u64 %rd1, [param_output];

    // gid = ctaid.x * ntid.x + tid.x
    mov.u32 %r0, %tid.x;
    mov.u32 %r1, %ntid.x;
    mov.u32 %r2, %ctaid.x;
    mad.lo.u32 %r3, %r2, %r1, %r0;

    // byte offset = gid * 4  (float32 element width)
    cvt.u64.u32 %rd2, %r3;
    mul.lo.u64  %rd3, %rd2, 4;
    add.u64     %rd4, %rd0, %rd3;
    add.u64     %rd5, %rd1, %rd3;

    ld.global.f32  %f0, [%rd4];
    call.uni (%r4), vprintf, ("idx=%u\n", %r3);
    mul.f32        %f1, %f0, %f0;
    st.global.f32  [%rd5], %f1;
    ret;
}
